{
	"name": "ms_TechActivity",
	"properties": {
		"content": {
			"query": "-- Limitations of SQL Serverless with Delta Lake: \n-- https://docs.microsoft.com/en-us/azure/synapse-analytics/sql/resources-self-help-sql-on-demand#delta-lake\n\n\n-- 0) Get info on inferred data types\n-- Notes: When querying the delta lake via T-SQL, the data types will be inferred based on what is specified in parquet.\n--        Parquet does not give you a way to specify column size, so strings are inferred as varchar(8000) which is not optimal.\nEXEC sp_describe_first_result_set N'\n\tSELECT * FROM \n    OPENROWSET(\n        BULK ''https://stoeacisd3ggimpl3.dfs.core.windows.net/stage2/ms_insights/TechActivity'',\n        FORMAT=''DELTA''\n    ) AS result';\n\n\n-- 1) Create a db via SQL serverless pool\nCREATE DATABASE s2_ms_insights;\nGO\nUSE s2_ms_insights;\nGO\n\n-- Always use UTF-8 collations.\n-- https://techcommunity.microsoft.com/t5/azure-synapse-analytics/always-use-utf-8-collations-to-read-utf-8-text-in-serverless-sql/ba-p/1883633\nALTER DATABASE s2_ms_insights \n    COLLATE Latin1_General_100_BIN2_UTF8;\n\n-- 2) set location info\nCREATE EXTERNAL DATA SOURCE DeltaLakeStorage\nWITH ( location = 'https://stoeacisd3ggimpl3.dfs.core.windows.net/stage2' );\nGO\nCREATE EXTERNAL FILE FORMAT DeltaLakeFormat WITH ( FORMAT_TYPE = DELTA );\nGO\n\n-- 3) Create an external table\n-- for info on data types: https://docs.microsoft.com/en-us/sql/t-sql/data-types/data-types-transact-sql?view=sql-server-ver15\n-- Note: this does not work for the columns used in partitioning the data because you always get null values (in this example you always get null for year and month). \n-- This is a known limitation: https://docs.microsoft.com/en-us/azure/synapse-analytics/sql/resources-self-help-sql-on-demand#partitioning-column-returns-null-values\nCREATE EXTERNAL TABLE TechActivity (\n     SignalType varchar(200),\n     StartTime datetime2,\n     UserAgent varchar(200),\n     SignalId varchar(200),\n     SisClassId varchar(200),\n     ClassId varchar(200),\n     ChannelId varchar(200),\n     AppName varchar(200),\n     ActorId varchar(200),\n     ActorRole varchar(200),\n     SchemaVersion varchar(50),\n     AssignmentId varchar(200),\n     SubmissionId varchar(200),\n     [Action] varchar(200),\n     DueDate datetime2,\n     ClassCreationDate datetime2,\n     Grade varchar(50),\n     SourceFileExtension varchar(50),\n     MeetingDuration int,\n     [year] smallint,\n     [month] tinyint\n) WITH (\n    LOCATION = '/ms_insights/TechActivity',\n    DATA_SOURCE = DeltaLakeStorage,\n    FILE_FORMAT = DeltaLakeFormat\n);\n\n\nselect * from TechActivity where year is not null\n\n--EXEC sp_describe_first_result_set N'\n\t--SELECT * FROM TechActivity AS result';\n\ndrop external table TechActivity2\n\nCREATE EXTERNAL FILE FORMAT ParquetFormat WITH ( FORMAT_TYPE = PARQUET );\nGO\n\n-- This will perform the select and copy the data to the specified LOCATION\nCREATE EXTERNAL TABLE TechActivity2\n  WITH (\n    LOCATION = '/ms_insights/TechActivity2',\n    DATA_SOURCE = DeltaLakeStorage,\n    FILE_FORMAT = ParquetFormat\n)\n  AS select \n     [SignalType] VARCHAR (200),\n     StartTime\n     from \n        OPENROWSET(BULK 'https://stoeacisd3ggimpl3.dfs.core.windows.net/stage2/ms_insights/TechActivity/year=2021/**',\n        FORMAT='PARQUET') AS [r]\n\n\n\n-- Create a partitioned view\n-- https://docs.microsoft.com/en-us/azure/synapse-analytics/sql/create-use-views#delta-lake-partitioned-views\nCREATE OR ALTER VIEW TechActivityView\nAS SELECT \n    CAST(SignalType as varchar(200)) as SignalType,\n    CAST(StartTime as datetime2) as StartTime,\n    CAST(UserAgent as varchar(200)) as UserAgent,\n    CAST(SignalId as varchar(200)) as SignalId,\n    CAST(SisClassId as varchar(200)) as SisClassId,\n    CAST(ClassId as varchar(200)) as ClassId,\n    CAST(ChannelId as varchar(200)) as ChannelId,\n    CAST(AppName as varchar(200)) as AppName,\n    CAST(ActorId as varchar(200)) as ActorId,\n    CAST(ActorRole as varchar(200)) as ActorRole,\n    CAST(SchemaVersion as varchar(50)) as SchemaVersion,\n    CAST(AssignmentId as varchar(200)) as AssignmentId,\n    CAST(SubmissionId as varchar(200)) as SubmissionId,\n    CAST([Action] as varchar(200)) as [Action],\n    CAST(DueDate as datetime2) as DueDate,\n    CAST(ClassCreationDate as datetime2) as ClassCreationDate,\n    CAST(Grade as varchar(50)) as Grade,\n    CAST(SourceFileExtension as varchar(50)) as SourceFileExtension,\n    CAST(MeetingDuration as int) as MeetingDuration,\n    CAST([year] as smallint) as [year],\n    CAST([month] as tinyint) as [month]\nFROM  \n    OPENROWSET(\n        BULK 'ms_insights/TechActivity',\n        DATA_SOURCE = 'DeltaLakeStorage',\n        FORMAT='DELTA'\n    ) AS [r]\n\nSELECT count(*) FROM TechActivityView\n\ndrop view TechActivityView2\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"poolName": "Built-in",
				"databaseName": "master"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}